<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KML Grid Generator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- KML Loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  
  <style>
    #progress {
      width: 100%;
      background: #eee;
      height: 20px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
      display: none;
    }
    #bar {
      background: #007bff;
      width: 0%;
      height: 100%;
      transition: width 0.2s linear;
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>KML â†’ Grid KML Generator</h1>

    <!-- PROGRESS BAR -->
    <div id="progress">
      <div id="bar"></div>
    </div>

    <script>
      function startProgress() {
        document.getElementById("progress").style.display = "block";
        let bar = document.getElementById("bar");
        let width = 0;
        let timer = setInterval(() => {
          if (width >= 95) clearInterval(timer);
          else {
            width += 1;
            bar.style.width = width + "%";
          }
        }, 25);
      }
    </script>

    <!-- UPLOAD FORM -->
    <form action="/" method="post" enctype="multipart/form-data" onsubmit="startProgress()">

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      {% endwith %}

      <div class="row">
        <label>Upload KML/KMZ</label>
        <input type="file" name="kmlfile" accept=".kml,.kmz" required>
      </div>

      <div class="row">
        <label>Grid size (meters)</label>
        <input type="number" name="grid_size" value="100" min="1" required>
      </div>

      <div class="row">
        <label>Grid ID prefix</label>
        <input type="text" name="prefix" value="G" maxlength="10">
      </div>

      <div class="row checkbox">
        <label><input type="checkbox" name="preview" checked> Show preview after generation</label>
      </div>

      <div class="row checkbox">
        <label><input type="checkbox" name="export_kmz"> Also export as KMZ</label>
      </div>

      <div class="row">
        <button type="submit">Generate Grid</button>
      </div>

    </form>

    <!-- PREVIEW + DOWNLOAD LINKS -->
    {% if preview_url %}
    <hr>

    <div class="info">
      <p>
        âœ… Generated <strong>{{ total_cells }}</strong> grid cells  
        <br>
        ðŸ“¥ Download:
        <a href="{{ download_url }}">KML</a>

        {% if download_kmz %}
          | <a href="{{ download_kmz }}">KMZ</a>
        {% endif %}

        {% if download_csv %}
          | <a href="{{ download_csv }}">Attribute Table (CSV)</a>
        {% endif %}
      </p>
    </div>

    <!-- MAP PREVIEW -->
    <div id="map" style="height:600px; border:1px solid #ccc;"></div>

    <script>
      var map = L.map('map').setView([20, 78], 5);

      L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom: 19, attribution: "Â© OpenStreetMap" }
      ).addTo(map);

      omnivore.kml("{{ preview_url }}")
        .on("ready", function () {
          map.fitBounds(this.getBounds());
          document.getElementById("bar").style.width = "100%";
        })
        .addTo(map);
    </script>
    {% endif %}

    <footer>
      <p style="margin-top:20px;">Developed by Krishnasureshkumar FG</p>
    </footer>
  </div>
</body>
</html>
